<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Acadexa â€“ Voice Demo</title>
  </head>
  <body>
    <h3>Acadexa â€“ Voice Demo</h3>

    <!-- =======================
         Day 16 + 17: Login Section
         ======================= -->
    <h2>Login</h2>
    <div
      style="
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 20px;
        max-width: 400px;
      "
    >
      <label for="loginUsername">Username:</label><br />
      <input id="loginUsername" type="text" style="width: 100%;" /><br /><br />

      <label for="loginPassword">Password:</label><br />
      <input
        id="loginPassword"
        type="password"
        style="width: 100%;"
      /><br /><br />

      <button type="button" onclick="login()">Login</button>
      <button type="button" onclick="logout()">Logout</button>

      <p id="loginStatus" style="margin-top: 10px; font-weight: bold;"></p>
      <p id="userInfo" style="margin-top: 5px;"></p> <!-- Day 17: current user info -->
    </div>

    <!-- Mic-based voice to text -->
    <button id="mic">ðŸŽ™ Start</button>
    <p>
      <strong>Transcript:</strong>
      <span id="transcript"></span>
    </p>

    <hr />

    <!-- Text-based Voice Command Tester -->
    <h2>ACADEXA â€“ Voice Command Tester</h2>

    <label for="commandInput">Type your command:</label>
    <input
      id="commandInput"
      type="text"
      placeholder="e.g. show students"
      style="width: 300px;"
    />
    <button type="button" onclick="sendCommand()">Send</button>

    <p>Response:</p>
    <div id="commandOutput" style="background: #f3f3f3; padding: 10px;"></div>

    <script>
      // ==============================
      // 0) Helper: get stored token
      // ==============================
      function getToken() {
        return localStorage.getItem("acadexa_token") || null;
      }

      // ==============================
      // 1) Voice recognition (mic â†’ text)
      // ==============================
      const micBtn = document.getElementById("mic");
      const transcriptSpan = document.getElementById("transcript");
      const commandInput = document.getElementById("commandInput");
      let recognition;

      if (
        !("webkitSpeechRecognition" in window) &&
        !("SpeechRecognition" in window)
      ) {
        transcriptSpan.textContent =
          "Web Speech API not supported in this browser.";
        micBtn.disabled = true;
      } else {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;

        recognition.onstart = () => {
          console.log("Speech recognition started");
          transcriptSpan.textContent = "Listening... please speak";
        };

        recognition.onspeechstart = () => {
          console.log("Speech detected");
        };

        recognition.onspeechend = () => {
          console.log("Speech ended");
        };

        recognition.onresult = (e) => {
          const text = e.results[0][0].transcript;
          transcriptSpan.textContent = text;
          commandInput.value = text;
        };

        recognition.onerror = (e) => {
          console.log("Speech error object:", e);
          transcriptSpan.textContent = "Error: " + e.error;
        };
      }

      micBtn.addEventListener("click", () => {
        if (recognition) recognition.start();
      });

      // ==============================
      // 2) Login / Logout using /auth/token
      // ==============================
      async function login() {
        const email = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const statusEl = document.getElementById("loginStatus");

        if (!email || !password) {
          statusEl.textContent = "Please enter email and password.";
          statusEl.style.color = "red";
          return;
        }

        statusEl.textContent = "Logging in...";
        statusEl.style.color = "black";

        try {
          const body = new URLSearchParams();
          body.append("grant_type", "password");
          body.append("username", email);
          body.append("password", password);

          const response = await fetch("http://127.0.0.1:8000/auth/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: body.toString(),
          });

          const text = await response.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = text;
          }

          console.log("Login response:", response.status, data);

          if (!response.ok) {
            const detail =
              (data && data.detail) ||
              (typeof data === "string" ? data : JSON.stringify(data));
            statusEl.textContent =
              "Login failed (" + response.status + "): " + detail;
            statusEl.style.color = "red";
            return;
          }

          const token = data.access_token || data.token;
          if (!token) {
            statusEl.textContent =
              "Login OK but token missing in response. Check backend.";
            statusEl.style.color = "red";
            return;
          }

          localStorage.setItem("acadexa_token", token);
          statusEl.textContent = "Login successful. Token stored.";
          statusEl.style.color = "green";

          // Day 17: fetch user details after successful login
          fetchCurrentUser();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Login error: " + err;
          statusEl.style.color = "red";
        }
      }

      function logout() {
        localStorage.removeItem("acadexa_token");
        const statusEl = document.getElementById("loginStatus");
        const infoEl = document.getElementById("userInfo");
        statusEl.textContent = "Logged out.";
        statusEl.style.color = "black";
        infoEl.textContent = "";
      }

      // ==============================
      // 2.5) Current user info using /auth/me (Day 17)
      // ==============================
      async function fetchCurrentUser() {
        const infoEl = document.getElementById("userInfo");
        const token = getToken();

        if (!token) {
          infoEl.textContent = "";
          return;
        }

        try {
          const response = await fetch("http://127.0.0.1:8000/auth/me", {
            method: "GET",
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          if (!response.ok) {
            infoEl.textContent = "";
            return;
          }

          const user = await response.json();
          // assuming backend returns { name, email, role, ... }
          infoEl.textContent =
            "Logged in as " +
            user.name +
            " (" +
            user.email +
            "), role: " +
            user.role;
        } catch (err) {
          console.error("Error fetching current user:", err);
          infoEl.textContent = "";
        }
      }

      // ==============================
      // 3) Send command to backend /voice-command
      // ==============================
      async function sendCommand() {
        const output = document.getElementById("commandOutput");
        const text = commandInput.value.trim();

        if (!text) {
          output.textContent = "Please type a command first.";
          return;
        }

        output.textContent = "Sending command...";

        const headers = {
          "Content-Type": "application/json",
        };

        const token = getToken();
        if (token) {
          headers["Authorization"] = "Bearer " + token;
        }

        try {
          const response = await fetch("http://127.0.0.1:8000/voice-command/", {
            method: "POST",
            headers: headers,
            body: JSON.stringify({ text: text }),
          });

          const data = await response.json();

          if (!response.ok) {
            output.textContent =
              "Error (" +
              response.status +
              "): " +
              (data.detail || JSON.stringify(data));
            return;
          }

          if (Array.isArray(data.result)) {
            renderTable(data.result, output);
          } else {
            output.textContent = JSON.stringify(data, null, 2);
          }
        } catch (err) {
          console.error(err);
          output.textContent = "Error calling backend: " + err;
        }
      }

      // Helper: result array ko HTML table me convert karo
      function renderTable(rows, container) {
        if (!rows || rows.length === 0) {
          container.textContent = "No data found.";
          return;
        }

        const columns = Object.keys(rows[0]);

        let html = "<table border='1' cellpadding='5' cellspacing='0'>";
        html += "<thead><tr>";
        for (const col of columns) {
          html += "<th>" + col + "</th>";
        }
        html += "</tr></thead>";

        html += "<tbody>";
        for (const row of rows) {
          html += "<tr>";
          for (const col of columns) {
            html += "<td>" + (row[col] ?? "") + "</td>";
          }
          html += "</tr>";
        }
        html += "</tbody></table>";

        container.innerHTML = html;
      }

      // Page load pe agar token already saved hai to current user info dikha do
      window.addEventListener("load", fetchCurrentUser);
    </script>
  </body>
</html>
